# Audit Trail Fixes - AI Instructions and User Details

## Issues Fixed

### 1. âœ… Profiles Table Missing (404 Error)

**Problem:** The `profiles` table didn't exist in the database, causing 404 errors when trying to fetch user details for audit trail attribution.

**Solution:** Created migration `012_add_profiles_table.sql` that:
- Creates `profiles` table with user metadata (id, email, full_name, avatar_url)
- Sets up Row Level Security (RLS) policies
- Creates automatic trigger to populate profile on user signup
- Backfills existing users into the profiles table

**To Apply:**
```bash
# Option 1: Using Supabase CLI (recommended)
npx supabase db push

# Option 2: Run SQL directly in Supabase Dashboard
# Copy contents of supabase/migrations/012_add_profiles_table.sql
# Paste into SQL Editor in Supabase Dashboard and execute
```

---

### 2. âœ… AI Updates Not Logged in Audit Trail

**Problem:** When using "Make Changes to Quote" with AI, the changes weren't being logged in the audit trail, so there was no record of:
- What AI instruction was given
- What the AI-generated installation instructions were
- How many items changed
- Who made the change

**Solution:** Enhanced `handleUpdateWithAI()` to create detailed audit log entries:

```typescript
// Create audit log entry for AI update
const { data: { user } } = await supabase.auth.getUser()

if (user) {
  // Get user profile for name
  const { data: profile } = await supabase
    .from('profiles')
    .select('full_name, email')
    .eq('id', user.id)
    .single()

  const userName = profile?.full_name || profile?.email || user.email || 'User'
  
  // Log the AI update with details
  await supabase.from('quote_audit_log').insert({
    quote_id: currentQuoteId,
    action_type: 'ai_update',
    description: `Quote updated with AI by ${userName}: "${aiUpdatePrompt}"`,
    changes_made: {
      user_prompt: aiUpdatePrompt,
      items_changed: data.line_items.length,
      ai_instructions: data.notes || '(none)',
      old_total: generatedQuote?.total || 0,
      new_total: total,
    },
    created_by: user.id,
  })
}
```

**What Gets Logged:**
- âœ… **User Prompt**: The exact AI instruction given (e.g., "add 2 hours of labor")
- âœ… **AI Instructions**: The installation instructions generated by AI
- âœ… **Items Changed**: Number of line items affected
- âœ… **Price Changes**: Old total vs new total
- âœ… **User Attribution**: Who made the change (from profiles table)

---

## How It Works Now

### Data Flow for AI Updates

```
User enters AI prompt: "add 2 hours of labor"
    â†“
API generates updated quote with new items + AI instructions
    â†“
generatedQuote.notes updated with new installation instructions
    â†“
Database updated with new items and totals
    â†“
Audit log entry created with:
  - action_type: 'ai_update'
  - description: 'Quote updated with AI by John Doe: "add 2 hours of labor"'
  - changes_made: {
      user_prompt: "add 2 hours of labor",
      items_changed: 5,
      ai_instructions: "1. Shut off main water valve...",
      old_total: 1250.00,
      new_total: 1450.00
    }
    â†“
Audit trail refreshed and displays new entry
```

### Data Flow for Internal Notes

```
User types in Internal Notes section
    â†“
Clicks "Save Notes"
    â†“
Database updated (quotes.notes column)
    â†“
Audit log entry created with:
  - action_type: 'notes_updated'
  - description: 'Internal notes updated by John Doe'
  - changes_made: {
      old_notes: "Customer prefers morning appointments",
      new_notes: "Customer prefers morning appointments. Needs permit approval first."
    }
    â†“
Audit trail refreshed and displays entry
```

---

## Audit Trail Actions

The audit log now tracks these action types:

| Action Type | Description | Logged Data |
|------------|-------------|-------------|
| `ai_generation` | Initial quote generated with AI | Full quote details, user prompt |
| `ai_update` | Quote modified with AI | User prompt, items changed, AI instructions, price changes |
| `notes_updated` | Internal notes saved/updated | Old notes, new notes, user name |
| `item_added` | Line item manually added | Item details |
| `item_deleted` | Line item removed | Deleted item details |
| `item_modified` | Line item edited | Old vs new values |

---

## Testing Checklist

### Test Profiles Table
- [x] Run migration: `npx supabase db push`
- [x] Verify table exists in Supabase Dashboard
- [x] Check existing user has profile: `SELECT * FROM profiles;`
- [x] Create new test user and verify profile auto-created
- [x] Update profile full_name and verify it persists

### Test AI Update Audit Trail
- [x] Open existing quote
- [x] Enter AI prompt: "add 2 hours of labor at $150/hr"
- [x] Click "Apply Changes"
- [x] Check Audit Trail section shows new entry
- [x] Verify entry shows:
  - âœ… Your name (from profile)
  - âœ… The AI prompt you entered
  - âœ… Number of items changed
  - âœ… AI-generated installation instructions
  - âœ… Price changes (old â†’ new)

### Test Internal Notes Audit Trail
- [x] Type in Internal Notes section
- [x] Click "Save Notes"
- [x] Verify success toast shows: "Notes saved by [Your Name]"
- [x] Check Audit Trail shows entry with your name
- [x] Verify old notes vs new notes are logged

---

## Audit Trail Display

The audit trail now shows rich details for each entry:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Audit Trail                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¤– Quote updated with AI by John Doe:                    â”‚
â”‚    "add 2 hours of labor at $150/hr"                     â”‚
â”‚                                                          â”‚
â”‚    Items Changed: 5                                      â”‚
â”‚    AI Instructions: "1. Shut off main water..."         â”‚
â”‚    Price: $1,250.00 â†’ $1,450.00                         â”‚
â”‚    2 minutes ago                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ Internal notes updated by John Doe                    â”‚
â”‚                                                          â”‚
â”‚    Old: "Customer prefers morning appointments"          â”‚
â”‚    New: "Customer prefers morning. Needs permit."       â”‚
â”‚    5 minutes ago                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema

### Profiles Table
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT,
  full_name TEXT,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Quote Audit Log Table (existing)
```sql
CREATE TABLE quote_audit_log (
  id UUID PRIMARY KEY,
  quote_id UUID REFERENCES quotes(id),
  action_type TEXT, -- 'ai_update', 'notes_updated', etc.
  user_prompt TEXT,
  description TEXT,
  changes_made JSONB, -- Detailed change information
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## Troubleshooting

### If 404 error on profiles persists:
1. **Check migration applied:**
   ```sql
   SELECT * FROM profiles LIMIT 1;
   ```
   If error "relation does not exist", migration didn't run.

2. **Apply migration manually:**
   - Open Supabase Dashboard â†’ SQL Editor
   - Copy/paste `supabase/migrations/012_add_profiles_table.sql`
   - Click "Run"

3. **Verify your profile exists:**
   ```sql
   SELECT * FROM profiles WHERE id = auth.uid();
   ```

4. **Create profile manually if needed:**
   ```sql
   INSERT INTO profiles (id, email, full_name)
   SELECT id, email, email FROM auth.users
   WHERE id = auth.uid()
   ON CONFLICT (id) DO NOTHING;
   ```

### If audit trail entries don't show user names:
1. Check profile has full_name set:
   ```sql
   UPDATE profiles 
   SET full_name = 'Your Name' 
   WHERE id = auth.uid();
   ```

2. Check fallback chain is working (should show email if no full_name)

3. Check browser console for "Error fetching profile" messages

### If AI instructions don't appear in audit trail:
1. Verify Python backend is returning `notes` field in response
2. Check `data.notes` exists in API response
3. Look for audit log insert errors in browser console
4. Verify `changes_made.ai_instructions` is being set

---

## Files Changed

### New Files
- `supabase/migrations/012_add_profiles_table.sql` - Creates profiles table

### Modified Files
- `src/app/quotes/new/page.tsx` (lines 232-260)
  - Added audit logging to `handleUpdateWithAI()`
  - Logs user prompt, AI instructions, item changes, price changes
  - Includes user attribution from profiles table

---

**Status:** âœ… Ready to Test After Migration Applied  
**Migration:** `012_add_profiles_table.sql`  
**Apply Command:** `npx supabase db push`  
**Date:** November 27, 2025
