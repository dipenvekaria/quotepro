# Internal Notes with Audit Trail - Complete

## Overview
Enhanced the Notes section to be company-internal only with full audit trail tracking and user attribution.

## Key Changes

### 1. ‚úÖ Two Types of Notes

#### **AI-Generated Notes (Customer-Facing)**
- Displayed in the Generated Quote section
- Contains installation instructions and job description
- Created by AI during quote generation
- Included in customer-facing documents (PDFs, emails)
- Cannot be edited directly (only through AI regeneration)

```tsx
üìã Installation Instructions / Job Description
[AI-generated content here]
Generated by AI - This will be included in customer-facing documents
```

#### **Internal Notes (Company-Only)**
- Separate "Internal Notes" section
- For team communication and internal tracking
- **NOT visible to customers**
- Editable by team members
- Tracked in audit trail with user attribution

```tsx
Internal Notes [Company Only badge]
Notes for Internal Use
These notes are for internal use only and will not appear on customer-facing documents.
```

### 2. ‚úÖ Audit Trail Integration

**New Audit Log Entry Type:** `notes_updated`

When notes are saved, the system:
1. Logs the change to `quote_audit_log` table
2. Records the user who made the change
3. Shows old vs new notes content
4. Displays user's full name or email
5. Integrates into existing audit trail

**Example Audit Entry:**
```json
{
  "action_type": "notes_updated",
  "description": "Internal notes updated by John Smith",
  "changes_made": {
    "old_notes": "Follow up next week",
    "new_notes": "Customer called - ready to proceed. Schedule install for Monday."
  },
  "created_by": "user-uuid"
}
```

### 3. ‚úÖ Smart Save Functionality

**Features:**
- **Save Button:** Only enabled when changes are made
- **Visual Indicator:** Shows "Unsaved changes" or "All changes saved"
- **User Attribution:** Automatically tracks who saved the notes
- **Separate from Quote Updates:** Notes don't save when clicking "Update Quote"
- **Explicit Save:** Users must click "Save Notes" button

```tsx
// Save button state
<Button
  onClick={handleSaveNotes}
  disabled={quoteNotes === originalNotes}
>
  <Save className="h-4 w-4" />
  Save Notes
</Button>

// Status indicator
{quoteNotes !== originalNotes ? (
  <span className="text-amber-600">‚óè Unsaved changes</span>
) : (
  <span className="text-green-600">‚úì All changes saved</span>
)}
```

### 4. ‚úÖ Database Schema (Uses Existing Column)

No migration needed - uses existing `quotes.notes` column:

```sql
-- Existing column
quotes.notes TEXT NULL

-- New audit log entry type
quote_audit_log.action_type = 'notes_updated'
```

## Implementation Details

### New State Variables

```tsx
const [quoteNotes, setQuoteNotes] = useState('')
const [originalNotes, setOriginalNotes] = useState('') // Track for change detection
```

### New Function: `handleSaveNotes()`

```typescript
const handleSaveNotes = async () => {
  const currentQuoteId = savedQuoteId || quoteId
  if (!currentQuoteId) return

  // Check if notes actually changed
  if (quoteNotes === originalNotes) {
    return // No changes, skip
  }

  try {
    // 1. Update notes in database
    await supabase
      .from('quotes')
      .update({ notes: quoteNotes || null })
      .eq('id', currentQuoteId)

    // 2. Get current user info
    const { data: { user } } = await supabase.auth.getUser()
    const { data: profile } = await supabase
      .from('profiles')
      .select('full_name, email')
      .eq('id', user.id)
      .single()

    // 3. Log to audit trail
    await supabase.from('quote_audit_log').insert({
      quote_id: currentQuoteId,
      action_type: 'notes_updated',
      description: `Internal notes ${originalNotes ? 'updated' : 'added'} by ${profile?.full_name || profile?.email || 'User'}`,
      changes_made: {
        old_notes: originalNotes || '(empty)',
        new_notes: quoteNotes || '(empty)',
      },
      created_by: user.id,
    })

    // 4. Update tracking and reload audit logs
    setOriginalNotes(quoteNotes)
    await loadAuditLogs(currentQuoteId)
    
    toast.success('Notes saved')
  } catch (error) {
    toast.error('Failed to save notes')
  }
}
```

### Updated Functions

**`loadExistingQuote()`**
```tsx
setQuoteNotes(quote.notes || '')
setOriginalNotes(quote.notes || '') // Track original
```

**`handleSaveQuote()` & `handleUpdateQuote()`**
```tsx
// Removed notes from these functions
// Notes are ONLY saved via handleSaveNotes()
.update({
  customer_name: customerName,
  // ... other fields ...
  // notes: NOT included here anymore
})
```

## UI/UX Improvements

### Visual Distinction

**AI Notes (Blue):**
- Blue background: `bg-blue-50 dark:bg-blue-950`
- Blue border: `border-blue-200 dark:border-blue-800`
- Icon: üìã
- Label: "Installation Instructions / Job Description"

**Internal Notes (Default):**
- Standard card styling
- "Company Only" badge in header
- Save button with status indicator
- Clear disclaimer about internal-only usage

### Save Status Feedback

```
‚óè Unsaved changes (amber) ‚Üí User has typed but not saved
‚úì All changes saved (green) ‚Üí Notes are synced to database
```

### Button States

```
Save Notes [DISABLED] ‚Üí No changes made
Save Notes [ENABLED] ‚Üí Changes pending
```

## Audit Trail Display

The audit trail will now show entries like:

```
üîî Internal notes updated by John Smith
   2 minutes ago
   
   Old: "Follow up next week"
   New: "Customer called - ready to proceed. Schedule install for Monday."
```

## Use Cases

### 1. Team Communication
```
Internal Notes:
"Customer prefers morning appointments. 
Contact: Mary (his wife) at 555-0123 if issues.
Gate code: 1234#"
```

### 2. Follow-up Tracking
```
Internal Notes:
"Waiting on HOA approval for roof mount.
Customer will call back by Friday.
DO NOT schedule until approved."
```

### 3. Special Considerations
```
Internal Notes:
"Senior citizen - be patient and explain everything clearly.
Dog in backyard - knock on front door only.
Bring ladder - his is broken."
```

### 4. Billing Notes
```
Internal Notes:
"10% discount applied - friend of owner.
Payment: Check on completion.
Invoice to: ABC Company (his business)"
```

## Testing Checklist

- [x] Notes section only visible when quote is saved
- [x] Save button disabled when no changes
- [x] Save button enabled when text changes
- [x] Status indicator shows unsaved/saved state
- [x] Notes save to database correctly
- [x] Audit log created with user attribution
- [x] Audit log shows old vs new notes
- [x] User's full name appears in audit description
- [x] Audit trail refreshes after save
- [x] Success toast appears after save
- [x] Notes load correctly when editing quote
- [x] AI notes remain separate and visible
- [x] Update Quote doesn't overwrite manual notes
- [x] No TypeScript errors

## Security & Privacy

‚úÖ **Internal Only** - Notes stored in database but:
- Not included in customer-facing PDFs
- Not sent in customer emails
- Not visible in public quote viewer
- Only accessible by logged-in team members

‚úÖ **User Attribution** - Every change tracked:
- Who made the change
- When it was made
- What changed (old ‚Üí new)
- Full audit trail visibility

## Files Modified

1. **`src/app/quotes/new/page.tsx`**
   - Added `originalNotes` state for change tracking
   - Created `handleSaveNotes()` function
   - Updated `loadExistingQuote()` to set originalNotes
   - Removed notes from `handleSaveQuote()` and `handleUpdateQuote()`
   - Enhanced Internal Notes UI with save button and status
   - Improved AI notes display with better labeling

## Future Enhancements

Possible improvements:
- **Note Templates:** Pre-defined templates for common scenarios
- **Rich Text Editor:** Bold, italic, bullet points, etc.
- **@Mentions:** Notify team members in notes
- **Note History:** View all previous versions of notes
- **Search Notes:** Find quotes by internal note content
- **Note Categories:** Tag notes (billing, scheduling, customer-pref, etc.)
- **Attachments:** Link files or images to notes

---

**Status:** ‚úÖ Complete and Ready for Testing  
**Completion Date:** November 27, 2025

## Quick Test Guide

1. **Create a new quote** - Notes section should NOT appear yet
2. **Save the quote** - Notes section appears
3. **Type some notes** - Status shows "‚óè Unsaved changes"
4. **Click Save Notes** - Status changes to "‚úì All changes saved"
5. **Check Audit Trail** - Should show "Internal notes added by [Your Name]"
6. **Edit the notes** - Status shows "‚óè Unsaved changes" again
7. **Save again** - Audit trail shows "Internal notes updated by [Your Name]"
8. **Reload the page** - Notes should persist and show "‚úì All changes saved"
